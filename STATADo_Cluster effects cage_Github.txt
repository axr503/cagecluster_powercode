f *************************************************************************************
*   
*   This file is intended as accompanying material for the manuscript entitled:
*
*   Understanding artificial mouse-microbiome heterogeneity and six actionable themes to increase study power.
*   Abigail R Basson, Alexandria LaSalla, Gretchen Lam, Danielle Kulpins, Erika L Moen, Mark Sundrud, Jun Miyoshi, 
*   Sanja Ilic, Betty R Theriault, Fabio Cominelli, Alexander Rodriguez-Palacios
*   bioRxiv 778043; doi: https://doi.org/10.1101/778043
*   Code Written for illustrative and guideline purposes.  
*   September 24, 2019
*
*************************************************************************************

Stata v15.1

/************************************************************************************* 	
*   Written in STATA as a do.file. 
*   STATA code and annotated output is to reproduce the data presented in Recommendation 
*   Theme 6 and Figure 9 on cage-cluster effects. 
*   
*   The goal is to illustrate how random distribution of mouse data to cage clusters 
*   results in different p-values and study power, which in turn depend on the statistical 
*   model used. 
*   This file contains the code to facilitate the analysis of cage-clustered data by 
*   mouse and microbiome research specialists/scientists.
************************************************************************************/


*****************************************************************************
* We identified from the published literature a suitable example with authors reporting 
* housing 5 mice/cage.
* Dataset derived from inferring data points from a 'dot plot' figure panel published 
* study (PMID not disclosed), where two mouse groups were treated with two diets.
* Authors did not report cage allocation, i.e., which mice (n=17 mice total) where in 
* which of 4 possible cages (2 cages/group) to conduct proper analysis.  
* 
* Here, we will simulate and compare the effect of 5 different scenarios of mice 
* arrangement into the 4 hypothetical cages, with up to 5 mice/cage and a range between 
* 3-5 mice/cage. The scenarios illustrate the effect of caging density in this example and * the lack of reproducibility in published literature if cage clustering is not accounted * for in the analysis.
*
* We herein describe the code for methods that do not control for clustering, as well as methods that do consider cluster data.
*****************************************************************************


/*
We chose STATA as primary means for the dissemination of the strategies related to this example, because it is a reliable, well-established software that has the combination of user-friendly analysis based on GUI interfaces (dropdown menus) for intuitive use by non experts, and the open-source community support that allows for, and encourages, the sharing of methods using reproducible written codes and macros with customizable options to suit scientists needs.
Other software can run all the statistics herein described, are open-sourced, and have been discussed and referenced in the manuscript, also with examples. 
Readers are encouraged to seek advice from epidemiologists/statisticians in their institutions as needed. This code is intended as a guide using the example in the manuscript. The methods although complex, are based on very basic codes here described and annotated.  


EXTRAPOLATION POTENTIAL TO OTHER EXPERIMENTS/DATASETS: 
If investigators have experiments consisting of two groups and two treatments, they only need to set their dataset matching the format and structure of the dataset below, and then run the code, line by line, as needed.  

*/


/*
---------------------
Dataset derived from inferring data points and hypothetical distribution of mice in four cages. 
(25 variables, 17 observations pasted into data editor) 
---------------------
rowID	treatment	treatcode	response	responselog2	clustscen1	clustscen2	clustscen3	clustscen4	clustscen5	clustscen1code	clustscen2code	clustscen3code	clustscen4code	clustscen5code	meancage_sc1	meancagelog_sc1	meancage_sc2	meancagelog_sc2	meancage_sc3	meancagelog_sc3	meancage_sc4	meancagelog_sc4	meancage_sc5	meancagelog_sc5	aweight_1	aweight_2	aweight_3	aweight_4	aweight_5
2	chow	1	2300	11.17	cage1	cage5	cage10	cage13	cage17	1	5	10	13	17	1725	10.66	1010	9.36	1933.333	10.84667	1520	10.418	1933.33	10.84667	4	4	3	5	3
4	chow	1	1100	10.10	cage1	cage5	cage9	cage13	cage18	1	5	9	13	18	1725	10.66	1010	9.36	573	8.89	1520	10.418	573	8.89	4	4	5	5	5
1	chow	1	2350	11.20	cage1	cage6	cage10	cage13	cage17	1	6	10	13	17	1725	10.66	1156.25	9.89	1933.333	10.84667	1520	10.418	1933.33	10.84667	4	4	3	5	3
3	chow	1	1150	10.17	cage1	cage6	cage10	cage13	cage17	1	6	10	13	17	1725	10.66	1156.25	9.89	1933.333	10.84667	1520	10.418	1933.33	10.84667	4	4	3	5	3
6	chow	1	490	8.94	cage2	cage5	cage9	cage14	cage18	2	5	9	14	18	441.25	8.5875	1010	9.36	573	8.89	355	8.3	573	8.89	4	4	5	3	5
8	chow	1	150	7.23	cage2	cage5	cage9	cage14	cage18	2	5	9	14	18	441.25	8.5875	1010	9.36	573	8.89	355	8.3	573	8.89	4	4	5	3	5
5	chow	1	700	9.45	cage2	cage6	cage9	cage13	cage18	2	6	9	13	18	441.25	8.5875	1156.25	9.89	573	8.89	1520	10.418	573	8.89	4	4	5	5	5
7	chow	1	425	8.73	cage2	cage6	cage9	cage14	cage18	2	6	9	14	18	441.25	8.5875	1156.25	9.89	573	8.89	355	8.3	573	8.89	4	4	5	3	5
9	wsd	2	1250	10.29	cage3	cage7	cage12	cage15	cage19	3	7	12	15	19	700	9.2225	438.00	8.25	700	9.2225	700	9.2225	700	9.2225	4	5	5	4	4
11	wsd	2	400	8.64	cage3	cage7	cage12	cage15	cage19	3	7	12	15	19	700	9.2225	438.00	8.25	700	9.2225	700	9.2225	700	9.2225	4	5	5	4	4
10	wsd	2	850	9.73	cage3	cage8	cage12	cage15	cage19	3	8	12	15	19	700	9.2225	372.50	8.19	700	9.2225	700	9.2225	700	9.2225	4	4	4	4	4
12	wsd	2	300	8.23	cage3	cage8	cage12	cage15	cage19	3	8	12	15	19	700	9.2225	372.50	8.19	700	9.2225	700	9.2225	700	9.2225	4	4	4	4	4
13	wsd	2	250	7.97	cage4	cage7	cage11	cage16	cage19	4	7	11	16	19	176	7.422	438.00	8.25	176	7.422	176	7.422	176	7.422	5	5	5	5	5
17	wsd	2	160	7.32	cage4	cage7	cage11	cage16	cage20	4	7	11	16	20	176	7.422	438.00	8.25	176	7.422	176	7.422	176	7.422	5	5	5	5	5
16	wsd	2	130	7.02	cage4	cage7	cage11	cage16	cage20	4	7	11	16	20	176	7.422	438.00	8.25	176	7.422	176	7.422	176	7.422	5	5	5	5	5
14	wsd	2	190	7.57	cage4	cage8	cage11	cage16	cage20	4	8	11	16	20	176	7.422	372.50	8.19	176	7.422	176	7.422	176	7.422	5	4	4	5	5
15	wsd	2	150	7.23	cage4	cage8	cage11	cage16	cage20	4	8	11	16	20	176	7.422	372.50	8.19	176	7.422	176	7.422	176	7.422	5	4	4	5	5
*/

gen cagescen1code = 1
replace cagescen1code = 2 if cagescen1 =="cage2"

sort treatment response
by treatment: summarize response responselog

/*

-> treatment = chow

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          8    1083.125    836.0577        150       2350
responselog2 |          8     9.62375    1.332409       7.23       11.2

-------------------------------------------------------------------------------------------------------
-> treatment = wsd

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          9    408.8889    386.3109        130       1250
responselog2 |          9    8.222222    1.143271       7.02      10.29

*/


********************************************************************************
********************************************************************************
*
* Method 0) THIS ARE THE METHODS USED IN THE PUBLISHED STUDY  
* Parametric and nonparametric two-sample tests; note different variances. T-tests are not ideal due to skewed data.
*
********************************************************************************
********************************************************************************

ttest response, by(treatment) /*P=0.0641*/
ttest responselog2, by(treatment) /*P=0.039*/

*nonparametric - preferred because data is skewed.
ranksum response, by(treatment) /*P=0.0484*/
ranksum responselog2, by(treatment) /*P=0.0484*/
ksmirnov response, by(treatment) exact /*P=0.034*/
ksmirnov responselog2, by(treatment) exact /*P=0.034*/


*================================================================================
* INTERPRETATION T UNIVARIATE METHOD WITHOUT CONTROLLING FOR CLUSTER:
* This univariate method does not consider cage allocation and thus it suggests that the diet is significant.
* T-test is significant only with log2 data. 
* With nonparametric the p-value is significant and the same regardless of the transformation.
* The experiment however cannot be examined with these tests because it does not fulfill one of the test assumptions: that the data points are not independent (because they are 
* from mice housed in two cages for each treatment).
*================================================================================



********************************************************************************
********************************************************************************
*
*	METHOD 1)	CLUSTERED DATA: mouse-level linear regression pooling. 
*
********************************************************************************
********************************************************************************



******************************************************************************
* 	METHOD 1a) simple regression model with one predictive variable: treatment
******************************************************************************

* Note that xi: is a STATA function for regression analysis that allows the use of categorical data available in text to be interpreted as such when an i. is added to the beginning of the variable name. 

xi: regress response i.treatment /*treatment significant; cage effect not tested*/ /*CLUSTER SCENARIO 1, see cage distribution under variable clustscen1)*/
*Note: Assumes each mouse is independent and cage cluster effect does not exist
*i. is a form of data coding in STATA when unit is in text format and/or when treatment is *categorical data.

/*
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      4.74
       Model |  1925340.71         1  1925340.71   Prob > F        =    0.0458
    Residual |  6086835.76        15  405789.051   R-squared       =    0.2403
-------------+----------------------------------   Adj R-squared   =    0.1897
       Total |  8012176.47        16  500761.029   Root MSE        =    637.02

-------------------------------------------------------------------------------
     response |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -674.2361    309.534    -2.18   0.046    -1333.992   -14.47998
        _cons |   1083.125   225.2191     4.81   0.000     603.0819    1563.168
-------------------------------------------------------------------------------
*This is interpreted as the effect of Treatment2 (wsd diet) was 674.2 units inferior compared to chow, with p=0.046
*/

*=========================================
* INTERPRETATION METHOD 1a:
* This univariate method does not consider cage allocation and thus it suggests that the *diet is significant.
*==========================================






***************************************************************************************
* METHOD 1b: Regression model with two predictive variables and cage allocation (cluster scenario; 'clustscen'), in this case both as categorical).
****************************************************************************************

*For cages, cage effects are compared to cage1 which is omitted (used as comparator)

/*
xi: regress response i.treatment i.clustscen1  /*treatment very significant; cage effect very significant*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
i.clustscen1      _Iclustscen_1-4     (_Iclustscen_1 for clus~1==cage1 omitted)
note: _Iclustscen_3 omitted because of collinearity

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(3, 13)        =     11.59
       Model |  5831537.72         3  1943845.91   Prob > F        =    0.0006
    Residual |  2180638.75        13  167741.442   R-squared       =    0.7278
-------------+----------------------------------   Adj R-squared   =    0.6650
       Total |  8012176.47        16  500761.029   Root MSE        =    409.56

-------------------------------------------------------------------------------
     response |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |      -1025   289.6044    -3.54   0.004    -1650.652   -399.3477
_Iclustscen_2 |   -1283.75   289.6044    -4.43   0.001    -1909.402   -658.0977
_Iclustscen_3 |          0  (omitted)
_Iclustscen_4 |       -524   274.7429    -1.91   0.079    -1117.546     69.5459
        _cons |       1725   204.7813     8.42   0.000     1282.597    2167.403
-------------------------------------------------------------------------------
*Notice that effect of treatment is more significant now at 0.004, but also notice that at least two cages are significantly different to cage 1. 
*This indicates that there is cage-cage difference and therefore the effect of treatment is confounded by cage effect. 
*The analysis is still pooled and assumes each mouse is independent, but they are not, they are highly correlated in each cluster. 
*Later we will compute the Intra-class correlation coefficient (ICC). See below other four cage assignment scenarios.
*/

xi: regress response i.treatment /*treatment significant p=0.046; cage effect not tested*/
xi: regress response i.treatment i.clustscen1  /*treatment very significant P=0.004; cage effect very significant, at least one cage had P=<0.001 compared to cage1*/
xi: regress response i.treatment i.clustscen2 /*treatment no significant P=0.209; cage effect not present P>0.766*/
xi: regress response i.treatment i.clustscen3 /*treatment very significant P=0.001; cage effect very significant, at least one cage had P=<0.001 compared to cage1*/
xi: regress response i.treatment i.clustscen4 /*treatment very significant P=0.023; cage effect very significant, at least one cage had P=<0.005 compared to cage1*/
xi: regress response i.treatment i.clustscen5 /*treatment very significant P=0.001; cage effect very significant*/
*#Controlling for intercatuions shows also that there is cage/treatement interactin, suiggesting that the interpretation needs to be made with care as treatement effect is confounded by cage effect/cluster.
xi: regress response i.treatment clustscen5code  i.treatment|clustscen5code/*treatment not significant p=0.068; cage effect not properly controlled (since codes were used as continuous data, but cage names are not relevant as numbers) is significant p<0.001; cage-traterment interatcion is  significant at p=0.051*/
xi: regress response i.treatment i.clustscen5code  i.treatment|clustscen5code/*treatment efect cannot be computed due to colinearity intorduced by inlcuding an interaction term between cage and treatment which is very significant P=0.06; cage afect as continuous very significant*/


/*
xi: regress response i.treatment i.clustscen2
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
i.clustscen2      _Iclustscen_1-4     (_Iclustscen_1 for clus~2==cage5 omitted)
note: _Iclustscen_4 omitted because of collinearity

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(3, 13)        =      1.42
       Model |  1977652.72         3  659217.574   Prob > F        =    0.2817
    Residual |  6034523.75        13  464194.135   R-squared       =    0.2468
-------------+----------------------------------   Adj R-squared   =    0.0730
       Total |  8012176.47        16  500761.029   Root MSE        =    681.32

-------------------------------------------------------------------------------
     response |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |     -637.5   481.7645    -1.32   0.209    -1678.289     403.289
_Iclustscen_2 |     146.25   481.7645     0.30   0.766     -894.539    1187.039
_Iclustscen_3 |       65.5    457.042     0.14   0.888    -921.8791    1052.879
_Iclustscen_4 |          0  (omitted)
        _cons |       1010    340.659     2.96   0.011      274.051    1745.949
-------------------------------------------------------------------------------
xi: regress response i.treatment i.clustscen3
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
i.clustscen3      _Iclustscen_1-4     (_Iclustscen_1 for clu~3==cage10 omitted)
note: _Iclustscen_3 omitted because of collinearity

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(3, 13)        =     12.97
       Model |   6005209.8         3   2001736.6   Prob > F        =    0.0003
    Residual |  2006966.67        13  154382.051   R-squared       =    0.7495
-------------+----------------------------------   Adj R-squared   =    0.6917
       Total |  8012176.47        16  500761.029   Root MSE        =    392.91

-------------------------------------------------------------------------------
     response |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1233.333   300.0936    -4.11   0.001    -1881.646   -585.0204
_Iclustscen_2 |       -524   263.5753    -1.99   0.068     -1093.42    45.41975
_Iclustscen_3 |          0  (omitted)
_Iclustscen_4 |  -1360.333   286.9444    -4.74   0.000    -1980.239   -740.4276
        _cons |   1933.333   226.8495     8.52   0.000     1443.255    2423.412
-------------------------------------------------------------------------------

. xi: regress response i.treatment i.clustscen4
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
i.clustscen4      _Iclustscen_1-4     (_Iclustscen_1 for clu~4==cage13 omitted)
note: _Iclustscen_3 omitted because of collinearity

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(3, 13)        =      7.51
       Model |  5080306.47         3  1693435.49   Prob > F        =    0.0036
    Residual |     2931870        13  225528.462   R-squared       =    0.6341
-------------+----------------------------------   Adj R-squared   =    0.5496
       Total |  8012176.47        16  500761.029   Root MSE        =     474.9

-------------------------------------------------------------------------------
     response |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |       -820   318.5715    -2.57   0.023    -1508.232   -131.7681
_Iclustscen_2 |      -1165   346.8167    -3.36   0.005    -1914.252    -415.748
_Iclustscen_3 |          0  (omitted)
_Iclustscen_4 |       -524   318.5715    -1.64   0.124    -1212.232    164.2319
        _cons |       1520    212.381     7.16   0.000     1061.179    1978.821
-------------------------------------------------------------------------------

. xi: regress response i.treatment i.clustscen5
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
i.clustscen5      _Iclustscen_1-4     (_Iclustscen_1 for clu~5==cage17 omitted)
note: _Iclustscen_3 omitted because of collinearity

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(3, 13)        =     12.97
       Model |   6005209.8         3   2001736.6   Prob > F        =    0.0003
    Residual |  2006966.67        13  154382.051   R-squared       =    0.7495
-------------+----------------------------------   Adj R-squared   =    0.6917
       Total |  8012176.47        16  500761.029   Root MSE        =    392.91

-------------------------------------------------------------------------------
     response |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1233.333   300.0936    -4.11   0.001    -1881.646   -585.0204
_Iclustscen_2 |  -1360.333   286.9444    -4.74   0.000    -1980.239   -740.4276
_Iclustscen_3 |          0  (omitted)
_Iclustscen_4 |       -524   263.5753    -1.99   0.068     -1093.42    45.41975
        _cons |   1933.333   226.8495     8.52   0.000     1443.255    2423.412
-------------------------------------------------------------------------------

*##############################
*#    CONTROLLING FOR treatment and cage INTERACTION IN CLUSTER SCENARIO 5. 
*##############################

*#  CODE A - integers are needed for this interaction analysis and not text format data. Codes were generated for this purpose.

 xi: regress response i.treatment clustscen5code  i.treatment|clustscen5code
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
i.trea~t|~5code   _ItreXclust_#       (coded as above)
note: clustscen5code omitted because of collinearity

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(3, 13)        =     12.97
       Model |   6005209.8         3   2001736.6   Prob > F        =    0.0003
    Residual |  2006966.67        13  154382.051   R-squared       =    0.7495
-------------+----------------------------------   Adj R-squared   =    0.6917
       Total |  8012176.47        16  500761.029   Root MSE        =    392.91

--------------------------------------------------------------------------------
      response |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
---------------+----------------------------------------------------------------
 _Itreatment_2 |     -14403   7223.651    -1.99   0.068    -30008.75    1202.749
clustscen5code |  -1360.333   286.9444    -4.74   0.000    -1980.239   -740.4276
clustscen5code |          0  (omitted)
 _ItreXclust_2 |   836.3333   389.6268     2.15   0.051    -5.404121    1678.071
         _cons |      25059   5059.303     4.95   0.000     14129.04    35988.96
--------------------------------------------------------------------------------


*#   CODE B - BELOW note that when interaction and controlling for cage are considered, it reveals that the model cannot be stable because the treatment in both groups controlling by cage are co-linear.
This exemplifies the complication of cage clustering data analysis especially when each treatment has only 2 cages. 

xi: regress response i.treatment i.clustscen5code  i.treatment|clustscen5code

i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
i.clustscen5c~e   _Iclustscen_17-20   (naturally coded; _Iclustscen_17 omitted)
i.trea~t|~5code   _ItreXclust_#       (coded as above)
note: _Itreatment_2 omitted because of collinearity
note: _Iclustscen_18 omitted because of collinearity
note: _Iclustscen_20 omitted because of collinearity

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(3, 13)        =     12.97
       Model |   6005209.8         3   2001736.6   Prob > F        =    0.0003
    Residual |  2006966.67        13  154382.051   R-squared       =    0.7495
-------------+----------------------------------   Adj R-squared   =    0.6917
       Total |  8012176.47        16  500761.029   Root MSE        =    392.91

--------------------------------------------------------------------------------
      response |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
---------------+----------------------------------------------------------------
 _Itreatment_2 |          0  (omitted)
_Iclustscen_18 |          0  (omitted)
_Iclustscen_19 |    -720.15   361.1825    -1.99   0.068    -1500.437    60.13746
_Iclustscen_20 |          0  (omitted)
clustscen5code |  -1360.333   286.9444    -4.74   0.000    -1980.239   -740.4276
 _ItreXclust_2 |   116.1833   35.86805     3.24   0.006     38.69512    193.6715
         _cons |      25059   5059.303     4.95   0.000     14129.04    35988.96
--------------------------------------------------------------------------------
*/



*      		Using log transformed data because data is right skewed.
*oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo*

* Shapiro-Wilk normality test to confirm the data is not normal. 
* Although normality is a requisite for univariate analysis such as T-test, normality is not necessary a prerequisite for regression analysis. 
* The source of statistical significance could be due to the skewed data for 'wsd' diet. Needs to be examined to determine to what extent is the effect of cage effect clustering/confounding for all scenarios

swilk responselog2 response
by treatment, sort : swilk responselog2 response

* visualize normality in a plot
pnorm response
pnorm responselog2, grid


/*-> treatment = chow

                   Shapiro-Wilk W test for normal data

    Variable |        Obs       W           V         z       Prob>z
-------------+------------------------------------------------------
responselog2 |          8    0.94448      0.773    -0.401    0.65566
    response |          8    0.86928      1.821     1.044    0.14832

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd

                   Shapiro-Wilk W test for normal data

    Variable |        Obs       W           V         z       Prob>z
-------------+------------------------------------------------------
responselog2 |          9    0.89547      1.536     0.749    0.22690
    response |          9    0.74693      3.718     2.576    0.00499  NOT NORMAL
	
	
swilk responselog2 response

                   Shapiro-Wilk W test for normal data

    Variable |        Obs       W           V         z       Prob>z
-------------+------------------------------------------------------
responselog2 |         17    0.93328      1.410     0.684    0.24684
    response |         17    0.79100      4.415     2.961    0.00153 NOT NORMAL

*/

 
xi: regress responselog2 i.treatment /*treatment significant p=0.034; cage effect not tested*/
xi: regress responselog2 i.treatment i.clustscen1  /*treatment significant P=0.016; cage effect very significant, at least one cage had P=<0.001 compared to cage1*/
xi: regress responselog2 i.treatment i.clustscen2 /*treatment no significant P=0.229; cage effect not present P>0.579*/
xi: regress responselog2 i.treatment i.clustscen3 /*treatment very significant P=0.021; cage effect very significant, at least one cage had P=<0.006 compared to cage1*/
xi: regress responselog2 i.treatment i.clustscen4 /*treatment very significant P=0.033; cage effect very significant, at least one cage had P=<0.002 compared to cage1*/
xi: regress responselog2 i.treatment i.clustscen5 /*treatment very significant P=0.021; cage effect very significant P<0.06*/
*  #Controlling for intercatuions shows also that there is cage/treatement interactin, suiggesting that the interpretation needs to be made with care as treatement effect is confounded by cage effect/cluster.
xi: regress responselog2 i.treatment clustscen5code  i.treatment|clustscen5code/*treatment not significant p=0.964; cage effect not properly controlled (since codes were used as continuous data, but cage names are not relevant as numbers) is significant p<0.006; cage-traterment interatcion is not significant at p=0.849*/
xi: regress responselog2 i.treatment i.clustscen5code  i.treatment|clustscen5code/*treatment efect cannot be computed due to colinearity intorduced by inlcuding an interaction term between cage and treatment which is very significant P=0.06; cage afect as continuous very significant*/


*=========================================
* INTERPRETATION METHOD 1b:
* This multivariate (two independent variables, treatment and cage arrangement) method considers the treatment and cage allocations as main effects and their interaction between treatment and the cage allocation.
* Note that the interactions and the way in which mice were assigned to the cage allocation determines whether the treatment is truly significant or confounded by the cage effect. 
*==========================================



****************************************************************************
****************************************************************************
*
*  METHOD 2)	Mouse-level regression (mean); no weighting
*
****************************************************************************
****************************************************************************


* First calculate the mean for each cage across scenarios. So called populations averaged analysis.
by treatment clustscen1, sort : summarize response responselog2
by treatment clustscen2, sort : summarize response responselog2
by treatment clustscen3, sort : summarize response responselog2
by treatment clustscen4, sort : summarize response responselog2
by treatment clustscen5, sort : summarize response responselog2

/*
. by treatment clustscen1, sort : summarize response responselog2

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen1 = cage1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          4        1725    693.4215       1100       2350
responselog2 |          4       10.66    .6070144       10.1       11.2

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen1 = cage2

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          4      441.25    226.8764        150        700
responselog2 |          4      8.5875    .9541618       7.23       9.45

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen1 = cage3

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          4         700    437.7975        300       1250
responselog2 |          4      9.2225    .9524486       8.23      10.29

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen1 = cage4

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          5         176    46.69047        130        250
responselog2 |          5       7.422    .3643761       7.02       7.97


. by treatment clustscen2, sort : summarize response responselog2

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen2 = cage5

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          4        1010     945.551        150       2300
responselog2 |          4        9.36    1.686911       7.23      11.17

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen2 = cage6

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          4     1156.25    850.0919        425       2350
responselog2 |          4      9.8875    1.054147       8.73       11.2

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen2 = cage7

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          5         438    465.9077        130       1250
responselog2 |          5       8.248     1.30095       7.02      10.29

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen2 = cage8

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          4       372.5    324.5895        150        850
responselog2 |          4        8.19    1.107429       7.23       9.73


. by treatment clustscen3, sort : summarize response responselog2

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen3 = cage10

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          3    1933.333    678.8471       1150       2350
responselog2 |          3    10.84667    .5862024      10.17       11.2

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen3 = cage9

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          5         573    354.1116        150       1100
responselog2 |          5        8.89    1.067872       7.23       10.1

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen3 = cage11

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          5         176    46.69047        130        250
responselog2 |          5       7.422    .3643761       7.02       7.97

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen3 = cage12

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          4         700    437.7975        300       1250
responselog2 |          4      9.2225    .9524486       8.23      10.29


. by treatment clustscen4, sort : summarize response responselog2

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen4 = cage13

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          5        1520      755.48        700       2350
responselog2 |          5      10.418    .7544335       9.45       11.2

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen4 = cage14

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          3         355    180.4855        150        490
responselog2 |          3         8.3    .9325768       7.23       8.94

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen4 = cage15

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          4         700    437.7975        300       1250
responselog2 |          4      9.2225    .9524486       8.23      10.29

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen4 = cage16

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          5         176    46.69047        130        250
responselog2 |          5       7.422    .3643761       7.02       7.97


. by treatment clustscen5, sort : summarize response responselog2

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen5 = cage17

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          3    1933.333    678.8471       1150       2350
responselog2 |          3    10.84667    .5862024      10.17       11.2

-----------------------------------------------------------------------------------------------------------------
-> treatment = chow, clustscen5 = cage18

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          5         573    354.1116        150       1100
responselog2 |          5        8.89    1.067872       7.23       10.1

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen5 = cage19

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          4         700    437.7975        300       1250
responselog2 |          4      9.2225    .9524486       8.23      10.29

-----------------------------------------------------------------------------------------------------------------
-> treatment = wsd, clustscen5 = cage20

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          5         176    46.69047        130        250
responselog2 |          5       7.422    .3643761       7.02       7.97

*/


/*
. xi: reg  meancage_sc1 i.treatment /*Treatmemnt is sig = P=0.016*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      7.39
       Model |  1925340.71         1  1925340.71   Prob > F        =    0.0158
    Residual |  3906197.01        15  260413.134   R-squared       =    0.3302
-------------+----------------------------------   Adj R-squared   =    0.2855
       Total |  5831537.72        16  364471.108   Root MSE        =    510.31

-------------------------------------------------------------------------------
 meancage_sc1 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -674.2361   247.9646    -2.72   0.016     -1202.76   -145.7121
        _cons |   1083.125   180.4207     6.00   0.000     698.5673    1467.683
-------------------------------------------------------------------------------

. xi: reg  meancage_sc2 i.treatment /*Treatmemnt is sig = P=0.000*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =    552.07
       Model |  1925340.71         1  1925340.71   Prob > F        =    0.0000
    Residual |  52312.0139        15  3487.46759   R-squared       =    0.9735
-------------+----------------------------------   Adj R-squared   =    0.9718
       Total |  1977652.72        16  123603.295   Root MSE        =    59.055

-------------------------------------------------------------------------------
 meancage_sc2 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -674.2361   28.69547   -23.50   0.000    -735.3991   -613.0732
        _cons |   1083.125   20.87902    51.88   0.000     1038.622    1127.628
-------------------------------------------------------------------------------

. xi: reg  meancage_sc3 i.treatment /*Treatmemnt is sig = P=0.018*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      7.08
       Model |  1925340.01         1  1925340.01   Prob > F        =    0.0178
    Residual |  4079867.44        15  271991.162   R-squared       =    0.3206
-------------+----------------------------------   Adj R-squared   =    0.2753
       Total |  6005207.45        16  375325.465   Root MSE        =    521.53

-------------------------------------------------------------------------------
 meancage_sc3 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |   -674.236   253.4169    -2.66   0.018    -1214.381   -134.0906
        _cons |   1083.125   184.3879     5.87   0.000     690.1114    1476.138
-------------------------------------------------------------------------------

. xi: reg  meancage_sc4 i.treatment /*Treatmemnt is sig = P=0.009*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      9.15
       Model |  1925340.71         1  1925340.71   Prob > F        =    0.0085
    Residual |  3154965.76        15  210331.051   R-squared       =    0.3790
-------------+----------------------------------   Adj R-squared   =    0.3376
       Total |  5080306.47        16  317519.154   Root MSE        =    458.62

-------------------------------------------------------------------------------
 meancage_sc4 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -674.2361   222.8486    -3.03   0.009    -1149.227   -199.2456
        _cons |   1083.125   162.1462     6.68   0.000     737.5186    1428.731
-------------------------------------------------------------------------------

. xi: reg  meancage_sc5 i.treatment /*Treatmemnt is sig = P=0.018*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      7.08
       Model |  1925333.47         1  1925333.47   Prob > F        =    0.0178
    Residual |  4079851.87        15  271990.125   R-squared       =    0.3206
-------------+----------------------------------   Adj R-squared   =    0.2753
       Total |  6005185.34        16  375324.084   Root MSE        =    521.53

-------------------------------------------------------------------------------
 meancage_sc5 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -674.2348   253.4164    -2.66   0.018    -1214.379   -134.0905
        _cons |   1083.124   184.3875     5.87   0.000      690.111    1476.136
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc1 i.treatment /*Treatmemnt is sig = P=0.013*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      7.90
       Model |  8.31930209         1  8.31930209   Prob > F        =    0.0132
    Residual |  15.7945143        15  1.05296762   R-squared       =    0.3450
-------------+----------------------------------   Adj R-squared   =    0.3013
       Total |  24.1138164        16  1.50711352   Root MSE        =    1.0261

-------------------------------------------------------------------------------
meancagelog~1 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.401528   .4986154    -2.81   0.013    -2.464301    -.338754
        _cons |    9.62375    .362796    26.53   0.000     8.850468    10.39703
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc2 i.treatment /*Treatmemnt is sig = P=0.000*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =    219.05
       Model |  8.32095516         1  8.32095516   Prob > F        =    0.0000
    Residual |  .569801568        15  .037986771   R-squared       =    0.9359
-------------+----------------------------------   Adj R-squared   =    0.9316
       Total |  8.89075672        16  .555672295   Root MSE        =     .1949

-------------------------------------------------------------------------------
meancagelog~2 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.401667   .0947053   -14.80   0.000    -1.603526   -1.199807
        _cons |      9.625   .0689082   139.68   0.000     9.478126    9.771874
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc3 i.treatment /*Treatmemnt is sig = P=0.010*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      8.68
       Model |  8.31932332         1  8.31932332   Prob > F        =    0.0100
    Residual |  14.3825438        15  .958836251   R-squared       =    0.3665
-------------+----------------------------------   Adj R-squared   =    0.3242
       Total |  22.7018671        16  1.41886669   Root MSE        =     .9792

-------------------------------------------------------------------------------
meancagelog~3 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.401529   .4758066    -2.95   0.010    -2.415687   -.3873717
        _cons |   9.623752   .3462001    27.80   0.000     8.885843    10.36166
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc4 i.treatment /*Treatmemnt is sig = P=0.013*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      7.99
       Model |  8.31930775         1  8.31930775   Prob > F        =    0.0127
    Residual |  15.6151076        15  1.04100718   R-squared       =    0.3476
-------------+----------------------------------   Adj R-squared   =    0.3041
       Total |  23.9344154        16  1.49590096   Root MSE        =    1.0203

-------------------------------------------------------------------------------
meancagelog~4 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.401528   .4957755    -2.83   0.013    -2.458249   -.3448076
        _cons |    9.62375   .3607297    26.68   0.000     8.854873    10.39263
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc5 i.treatment /*Treatmemnt is sig = P=0.010*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      8.68
       Model |  8.31932332         1  8.31932332   Prob > F        =    0.0100
    Residual |  14.3825438        15  .958836251   R-squared       =    0.3665
-------------+----------------------------------   Adj R-squared   =    0.3242
       Total |  22.7018671        16  1.41886669   Root MSE        =     .9792

-------------------------------------------------------------------------------
meancagelog~5 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.401529   .4758066    -2.95   0.010    -2.415687   -.3873717
        _cons |   9.623752   .3462001    27.80   0.000     8.885843    10.36166
-------------------------------------------------------------------------------

*/

* The remaining of the scenarios with and without log transformed data (output section above):
xi: reg  meancage_sc1 i.treatment /*Treatmemnt is sig = P=0.016*/
xi: reg  meancage_sc2 i.treatment /*Treatmemnt is sig = P=0.000*/
xi: reg  meancage_sc3 i.treatment /*Treatmemnt is sig = P=0.018*/
xi: reg  meancage_sc4 i.treatment /*Treatmemnt is sig = P=0.009*/
xi: reg  meancage_sc5 i.treatment /*Treatmemnt is sig = P=0.018*/
xi: reg  meancagelog_sc1 i.treatment /*Treatmemnt is sig = P=0.013*/
xi: reg  meancagelog_sc2 i.treatment /*Treatmemnt is sig = P=0.000*/
xi: reg  meancagelog_sc3 i.treatment /*Treatmemnt is sig = P=0.010*/
xi: reg  meancagelog_sc4 i.treatment /*Treatmemnt is sig = P=0.013*/
xi: reg  meancagelog_sc5 i.treatment /*Treatmemnt is sig = P=0.010*/

*=========================================
* INTERPRETATION METHOD 2 in this scenario: 
* This univariate method in this scenario misleadingly suggests that the diet is always significant as this analytically and artificially smoothens the cage effect.
*==========================================






****************************************************************************
****************************************************************************
*
* METHOD 3)	Mouse-level regression (mean); weighting – analytic weights. 
*
****************************************************************************
****************************************************************************


* As described in STATA, analytic weights (aweights)  are typically appropriate when you are dealing with
* data containing averages.  For instance, you have average income and
* average characteristics on a group of people.  The weighting variable
* contains the number of persons over which the average was calculated (or
* a number proportional to that amount).

xi: reg  meancage_sc1 i.treatment [aweight = aweight_1]/*Treatmemnt is sig = P=0.011*/
xi: reg  meancage_sc2 i.treatment [aweight = aweight_2]/*Treatmemnt is sig = P=0.000*/
xi: reg  meancage_sc3 i.treatment [aweight = aweight_3]/*Treatmemnt is sig = P=0.038*/
xi: reg  meancage_sc4 i.treatment [aweight = aweight_4]/*Treatmemnt is sig = P=0.001*/
xi: reg  meancage_sc5 i.treatment [aweight = aweight_5]/*Treatmemnt is sig = P=0.031*/
xi: reg  meancagelog_sc1 i.treatment [aweight = aweight_1]/*Treatmemnt is sig = P=0.008*/
xi: reg  meancagelog_sc2 i.treatment [aweight = aweight_2]/*Treatmemnt is sig = P=0.000*/
xi: reg  meancagelog_sc3 i.treatment [aweight = aweight_3]/*Treatmemnt is sig = P=0.019*/
xi: reg  meancagelog_sc4 i.treatment [aweight = aweight_4]/*Treatmemnt is sig = P=0.002*/
xi: reg  meancagelog_sc5 i.treatment [aweight = aweight_5]/*Treatmemnt is sig = P=0.012*/

*=========================================
* INTERPRETATION METHOD 3: 
* (see output of regressions below)
* This univariate method, after adjusting for the number of observations in each cage, still misleadingly suggests that the diet is always significant, again, as mentioned for method 2, this analytically and artificially smoothens the cage effect.
*==========================================

/*
. xi: reg  meancage_sc1 i.treatment [aweight = aweight_1]/*Treatmemnt is sig = P=0.016*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 73)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      8.39
       Model |  2066328.23         1  2066328.23   Prob > F        =    0.0111
    Residual |  3694100.64        15  246273.376   R-squared       =    0.3587
-------------+----------------------------------   Adj R-squared   =    0.3160
       Total |  5760428.87        16  360026.804   Root MSE        =    496.26

-------------------------------------------------------------------------------
 meancage_sc1 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -702.6372   242.5717    -2.90   0.011    -1219.667   -185.6078
        _cons |   1083.125   181.7903     5.96   0.000     695.6481    1470.602
-------------------------------------------------------------------------------

. xi: reg  meancage_sc2 i.treatment [aweight = aweight_2]/*Treatmemnt is sig = P=0.000*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 73)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =    569.41
       Model |  1882675.57         1  1882675.57   Prob > F        =    0.0000
    Residual |  49595.4268        15  3306.36179   R-squared       =    0.9743
-------------+----------------------------------   Adj R-squared   =    0.9726
       Total |  1932270.99        16  120766.937   Root MSE        =    57.501

-------------------------------------------------------------------------------
 meancage_sc2 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |   -670.686   28.10649   -23.86   0.000    -730.5935   -610.7784
        _cons |   1083.125   21.06382    51.42   0.000     1038.229    1128.021
-------------------------------------------------------------------------------

. xi: reg  meancage_sc3 i.treatment [aweight = aweight_3]/*Treatmemnt is sig = P=0.018*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 75)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      5.16
       Model |  1170240.93         1  1170240.93   Prob > F        =    0.0383
    Residual |  3404203.03        15  226946.869   R-squared       =    0.2558
-------------+----------------------------------   Adj R-squared   =    0.2062
       Total |  4574443.96        16  285902.747   Root MSE        =    476.39

-------------------------------------------------------------------------------
 meancage_sc3 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -527.0394   232.0959    -2.27   0.038     -1021.74   -32.33862
        _cons |   933.0881   171.6046     5.44   0.000     567.3217    1298.855
-------------------------------------------------------------------------------

. xi: reg  meancage_sc4 i.treatment [aweight = aweight_4]/*Treatmemnt is sig = P=0.009*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 75)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =     16.52
       Model |  2910227.37         1  2910227.37   Prob > F        =    0.0010
    Residual |  2643029.96        15  176201.997   R-squared       =    0.5241
-------------+----------------------------------   Adj R-squared   =    0.4923
       Total |  5553257.32        16  347078.583   Root MSE        =    419.76

-------------------------------------------------------------------------------
 meancage_sc4 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -831.1298   204.5082    -4.06   0.001    -1267.029   -395.2308
        _cons |   1211.618   151.2071     8.01   0.000     889.3274    1533.908
-------------------------------------------------------------------------------

. xi: reg  meancage_sc5 i.treatment [aweight = aweight_5]/*Treatmemnt is sig = P=0.018*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 75)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      5.70
       Model |  1286501.22         1  1286501.22   Prob > F        =    0.0305
    Residual |  3382938.84        15  225529.256   R-squared       =    0.2755
-------------+----------------------------------   Adj R-squared   =    0.2272
       Total |  4669440.05        16  291840.003   Root MSE        =     474.9

-------------------------------------------------------------------------------
 meancage_sc5 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -552.5995   231.3699    -2.39   0.031    -1045.753   -59.44627
        _cons |   933.0873   171.0678     5.45   0.000     568.4651     1297.71
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc1 i.treatment [aweight = aweight_1]/*Treatmemnt is sig = P=0.013*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 73)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      9.18
       Model |  9.40605111         1  9.40605111   Prob > F        =    0.0084
    Residual |  15.3673885        15  1.02449257   R-squared       =    0.3797
-------------+----------------------------------   Adj R-squared   =    0.3383
       Total |  24.7734396        16  1.54833998   Root MSE        =    1.0122

-------------------------------------------------------------------------------
meancagelog~1 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.499116   .4947501    -3.03   0.008    -2.553651   -.4445808
        _cons |    9.62375   .3707801    25.96   0.000     8.833451    10.41405
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc2 i.treatment [aweight = aweight_2]/*Treatmemnt is sig = P=0.000*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 73)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =    230.99
       Model |  8.18481859         1  8.18481859   Prob > F        =    0.0000
    Residual |  .531501103        15  .035433407   R-squared       =    0.9390
-------------+----------------------------------   Adj R-squared   =    0.9350
       Total |  8.71631969        16  .544769981   Root MSE        =    .18824

-------------------------------------------------------------------------------
meancagelog~2 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.398415   .0920106   -15.20   0.000    -1.594531   -1.202299
        _cons |      9.625   .0689554   139.58   0.000     9.478025    9.771975
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc3 i.treatment [aweight = aweight_3]/*Treatmemnt is sig = P=0.010*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 75)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      6.86
       Model |  6.02106204         1  6.02106204   Prob > F        =    0.0193
    Residual |  13.1626036        15  .877506905   R-squared       =    0.3139
-------------+----------------------------------   Adj R-squared   =    0.2681
       Total |  19.1836656        16   1.1989791   Root MSE        =    .93675

-------------------------------------------------------------------------------
meancagelog~3 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.195479   .4563843    -2.62   0.019    -2.168239    -.222719
        _cons |   9.407942   .3374364    27.88   0.000     8.688714    10.12717
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc4 i.treatment [aweight = aweight_4]/*Treatmemnt is sig = P=0.013*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 75)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =     13.65
       Model |  12.6486885         1  12.6486885   Prob > F        =    0.0022
    Residual |  13.8977446        15  .926516308   R-squared       =    0.4765
-------------+----------------------------------   Adj R-squared   =    0.4416
       Total |  26.5464331        16  1.65915207   Root MSE        =    .96256

-------------------------------------------------------------------------------
meancagelog~4 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.732719   .4689558    -3.69   0.002    -2.732275   -.7331634
        _cons |   9.857353   .3467315    28.43   0.000     9.118313    10.59639
-------------------------------------------------------------------------------

. xi: reg  meancagelog_sc5 i.treatment [aweight = aweight_5]/*Treatmemnt is sig = P=0.010*/
i.treatment       _Itreatment_1-2     (_Itreatment_1 for treat~t==chow omitted)
(sum of wgt is 75)

      Source |       SS           df       MS      Number of obs   =        17
-------------+----------------------------------   F(1, 15)        =      8.06
       Model |  6.93826972         1  6.93826972   Prob > F        =    0.0124
    Residual |  12.9116935        15  .860779568   R-squared       =    0.3495
-------------+----------------------------------   Adj R-squared   =    0.3062
       Total |  19.8499632        16   1.2406227   Root MSE        =    .92778

-------------------------------------------------------------------------------
meancagelog~5 |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
_Itreatment_2 |  -1.283308   .4520135    -2.84   0.012    -2.246752   -.3198644
        _cons |   9.407942   .3342048    28.15   0.000     8.695602    10.12028
-------------------------------------------------------------------------------
*/




****************************************************************************
****************************************************************************
*
*  METHOD 4)	Marginal regression
*
****************************************************************************
****************************************************************************

	

/*#First set cageid as the panel variable (cluster identities), then perform the regression
xtset clustscen1code *this corresponds to cageid and needs to be numeric
xtgee is a command in stata to Fit population-averaged panel-data models by using GEE. 
xtgee fits population-averaged panel-data models.  In particular, xtgee fits generalized linear models and allows you to specify the within-group
correlation structure for the panels.
*/
	xtset clustscen1code
	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*Treatmemnt is nonsig = P=0.165*/
	xtgee response treatcode, family(gaussian) link(identity) corr(exchangeable) /*Treatmemnt is nonsig = P=0.165; using treatments categorical or continuous is the same*/ 

	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust /*Treatmemnt is nonsig = P=0.250*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*Treatmemnt is nonsig = P=0.172*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust /*Treatmemnt is nonsig = P=0.241*/

	*the family and link functions are best suited in this exampole because the data has a normal distribution, especially after logtransformation, although it is not necessary as an assumption for linear regression.
/*
xtset clustscen1code
       panel variable:  clustscen1code (unbalanced)

xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) 

Iteration 1: tolerance = .03491116
Iteration 2: tolerance = .00008832
Iteration 3: tolerance = 2.468e-07

GEE population-averaged model                   Number of obs     =         17
Group variable:               clustscen1~e      Number of groups  =          4
Link:                             identity      Obs per group:
Family:                           Gaussian                    min =          4
Correlation:                  exchangeable                    avg =        4.2
                                                              max =          5
                                                Wald chi2(1)      =       1.93
Scale parameter:                  358344.8      Prob > chi2       =     0.1650

------------------------------------------------------------------------------
    response |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 2.treatcode |  -650.6051   468.6298    -1.39   0.165    -1569.103    267.8925
       _cons |   1083.125   333.1178     3.25   0.001     430.2261    1736.024
------------------------------------------------------------------------------

.         xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust

Iteration 1: tolerance = .03491116
Iteration 2: tolerance = .00008832
Iteration 3: tolerance = 2.468e-07

GEE population-averaged model                   Number of obs     =         17
Group variable:               clustscen1~e      Number of groups  =          4
Link:                             identity      Obs per group:
Family:                           Gaussian                    min =          4
Correlation:                  exchangeable                    avg =        4.2
                                                              max =          5
                                                Wald chi2(1)      =       1.32
Scale parameter:                  358344.8      Prob > chi2       =     0.2504

                         (Std. Err. adjusted for clustering on clustscen1code)
------------------------------------------------------------------------------
             |               Robust
    response |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 2.treatcode |  -650.6051   566.0315    -1.15   0.250    -1760.006    458.7962
       _cons |   1083.125   524.0887     2.07   0.039     55.92994     2110.32
------------------------------------------------------------------------------

.         xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) 

Iteration 1: tolerance = .03575438
Iteration 2: tolerance = .00022402
Iteration 3: tolerance = 1.515e-06
Iteration 4: tolerance = 1.025e-08

GEE population-averaged model                   Number of obs     =         17
Group variable:               clustscen1~e      Number of groups  =          4
Link:                             identity      Obs per group:
Family:                           Gaussian                    min =          4
Correlation:                  exchangeable                    avg =        4.2
                                                              max =          5
                                                Wald chi2(1)      =       1.87
Scale parameter:                  1.350053      Prob > chi2       =     0.1716

------------------------------------------------------------------------------
responselog2 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 2.treatcode |   -1.31514   .9619992    -1.37   0.172    -3.200624    .5703435
       _cons |    9.62375   .6828276    14.09   0.000     8.285432    10.96207
------------------------------------------------------------------------------

.         xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust

Iteration 1: tolerance = .03575438
Iteration 2: tolerance = .00022402
Iteration 3: tolerance = 1.515e-06
Iteration 4: tolerance = 1.025e-08

GEE population-averaged model                   Number of obs     =         17
Group variable:               clustscen1~e      Number of groups  =          4
Link:                             identity      Obs per group:
Family:                           Gaussian                    min =          4
Correlation:                  exchangeable                    avg =        4.2
                                                              max =          5
                                                Wald chi2(1)      =       1.38
Scale parameter:                  1.350053      Prob > chi2       =     0.2406

                         (Std. Err. adjusted for clustering on clustscen1code)
------------------------------------------------------------------------------
             |               Robust
responselog2 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 2.treatcode |   -1.31514   1.120682    -1.17   0.241    -3.511637    .8813561
       _cons |    9.62375   .8460947    11.37   0.000     7.965435    11.28207
------------------------------------------------------------------------------
*/
	xtset clustscen2code
	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*convergence not achieved!!!*/
	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust /*convergence not achieved!!!*/
	xtgee response i.treatcode, family(gaussian) link(identity) corr(independent) robust /*Significant at p=0.001 because we used Independenty correlation because we know that there is no cage effect!!!*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*convergence not achieved!!!*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*convergence not achieved!!!*/

	xtset clustscen3code 
	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*Treatmemnt is nonsig P=0.108*/
	xtgee response i.treatcode, family(gaussian) link(identity) corr(independent) /*Treatmemnt is sig P=0.020 assumes that all cages are independent*/
	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust /*Treatmemnt is nonsig = P=0.184*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*Treatmemnt is nonsig = P=0.104*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust /*Treatmemnt is nonsig = P=0.162*/

	xtset clustscen4code 
	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*Treatmemnt is nonsig P=0.194*/
	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust /*Treatmemnt is nonsig = P=0.283*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*Treatmemnt is nonsig = P=0.260*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust /*Treatmemnt is nonsig = P=0.335*/
	
	xtset clustscen5code 
	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*Treatmemnt is nonsig P=0.108*/
	xtgee response i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust /*Treatmemnt is nonsig = P=0.184*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) /*Treatmemnt is nonsig = P=0.104*/
	xtgee responselog i.treatcode, family(gaussian) link(identity) corr(exchangeable) robust /*Treatmemnt is nonsig = P=0.162*/

	
	Interpretation:
	*Scenario 2 (clustscen2code), where there was no cage effect, did not converge (because all cages contained mice representing all values over the y-axis.) 



**********************************************************************************************************
**********************************************************************************************************
*	METHOD 5)	Mixed-effect regression using xtmixed function 
*
*	For ulterior Post-hoc study power estimations, or for sample size estimations for future studies,
*	you may calculate the Intra-class correlation coefficient (ICC) once the mixed-model has been executed 
**********************************************************************************************************
**********************************************************************************************************
	
* regression using raw non-transformed response:
	xtset clustscen1code
	xtmixed response treatcode || clustscen1code:, variance robust cov(exch)
	estat icc
	
	xtset clustscen2code
	xtmixed response treatcode || clustscen2code:, variance robust cov(exch)
	estat icc
	
	xtset clustscen3code
	xtmixed response treatcode || clustscen3code:, variance robust cov(exch) 
	estat icc
	
	xtset clustscen4code
	xtmixed response treatcode || clustscen4code:, variance robust cov(exch)
	estat icc
	
	xtset clustscen5code
	xtmixed response treatcode || clustscen5code:, variance robust cov(exch)
	estat icc
	
* regression using log2 transformed response:
	
	xtset clustscen1code
	xtmixed responselog treatcode || clustscen1code:, variance robust cov(exch) 
	estat icc
	
	xtset clustscen2code
	xtmixed responselog treatcode || clustscen2code:, variance robust cov(exch) 
	estat icc
	
	xtset clustscen3code
	xtmixed responselog treatcode || clustscen3code:, variance robust cov(exch) 
	estat icc
	
	xtset clustscen4code
	xtmixed responselog treatcode || clustscen4code:, variance robust cov(exch)
	estat icc
	
	xtset clustscen5code
	xtmixed responselog treatcode || clustscen5code:, variance robust cov(exch)
	estat icc
	

*=========================================
* INTERPRETATION:
* (see output of regressions below)
* This mixed effect models illustrate that with the exception of scenario 2, scenarios 1, 3, 4 and 5 had 
* cages that contained clusters of highly correlated and influential mice. (high ICC; highly correlated mice within cage). 
* The analysis using cluster statistics indicated that the effect observed in scenarios 1, 3, 4 and 5 would have no significant treatment effect. 
* Notice that the regression in Method 2 showed statistical differences across cages in multivariable analysis.
*==========================================

------------------------------------------------------------------------------
      xtmixed|               Robust
	response |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
1  treatcode |  -649.8061    566.041    -1.15   0.251    -1759.226    459.6139
2  treatcode |  -674.2361    65.2866   -10.33   0.000    -802.1955   -546.2767 
3  treatcode |  -792.4923   594.3198    -1.33   0.182    -1957.338     372.353
4  treatcode |  -550.8784   518.9929    -1.06   0.288    -1568.086     466.329
5  treatcode |  -835.8584   584.2482    -1.43   0.153    -1980.964     309.247
------------------------------------------------------------------------------
             |               Robust
 responselog |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------------------------------------------------------
1  treatcode |  -1.314653    1.12069    -1.17   0.241    -3.511165    .8818582
2  treatcode |  -1.401528    .216617    -6.47   0.000    -1.826089   -.9769663
3  treatcode |  -1.515346   1.083962    -1.40   0.162    -3.639872    .6091802
4  treatcode |  -1.090596    1.13381    -0.96   0.336    -3.312822    1.131631
5  treatcode |  -1.665269   1.052521    -1.58   0.114    -3.728173    .3976344
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen1code |   .5400716   .1697282      .2353012    .8175563
              clustscen2code |   2.91e-22          0      2.91e-22    2.91e-22
              clustscen3code |   .5896643   .1242081      .3444441    .7971713
              clustscen4code |   .3838245   .1912594      .1132101    .7524403
              clustscen5code |   .5570979   .1288837      .3112272    .7778486
------------------------------------------------------------------------------
              clustscen1code |   .5977599   .1010516      .3947045    .7720387
              clustscen2code |   1.14e-24          0      1.14e-24    1.14e-24
              clustscen3code |   .5238115   .1230783      .2948816    .7431542
              clustscen4code |    .595588    .086908      .4206568     .749192
              clustscen5code |   .4740494    .117256      .2639286    .6937813

------------------------------------------------------------------------------


/* OUTPUT:

. do "/var/folders/6n/115993f90vx4895s8drv1jp40000gn/T//SD02624.000000"

.         xtset clustscen1code
       panel variable:  clustscen1code (unbalanced)

.         xtmixed response treatcode || clustscen1code:, variance robust cov(exch)
Note: single-variable random-effects specification in clustscen1code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood = -129.96905  
Iteration 1:   log pseudolikelihood = -129.96905  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen1code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          4
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =       1.32
Log pseudolikelihood = -129.96905               Prob > chi2       =     0.2510

                         (Std. Err. adjusted for 4 clusters in clustscen1code)
------------------------------------------------------------------------------
             |               Robust
    response |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -649.8061    566.041    -1.15   0.251    -1759.226    459.6139
       _cons |   1732.931   1069.771     1.62   0.105     -363.781    3829.643
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen1~e: Identity       |
                  var(_cons) |   197364.7   88812.07      81702.89    476761.7
-----------------------------+------------------------------------------------
               var(Residual) |     168077     107065      48227.32    585764.8
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen1code |   .5400716   .1697282      .2353012    .8175563
------------------------------------------------------------------------------

.         
.         xtset clustscen2code
       panel variable:  clustscen2code (unbalanced)

.         xtmixed response treatcode || clustscen2code:, variance robust cov(exch)
Note: single-variable random-effects specification in clustscen2code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood = -132.92063  
Iteration 1:   log pseudolikelihood = -132.82469  
Iteration 2:   log pseudolikelihood = -132.82357  
Iteration 3:   log pseudolikelihood = -132.82357  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen2code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          4
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =     106.65
Log pseudolikelihood = -132.82357               Prob > chi2       =     0.0000

                         (Std. Err. adjusted for 4 clusters in clustscen2code)
------------------------------------------------------------------------------
             |               Robust
    response |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -674.2361    65.2866   -10.33   0.000    -802.1955   -546.2767
       _cons |   1757.361   122.2983    14.37   0.000     1517.661    1997.061
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen2~e: Identity       |
                  var(_cons) |   1.04e-16   2.74e-14      2.4e-240    4.5e+207
-----------------------------+------------------------------------------------
               var(Residual) |   358049.2   143764.2      162992.5    786534.6
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen2code |   2.91e-22          0      2.91e-22    2.91e-22
------------------------------------------------------------------------------

.         
.         xtset clustscen3code
       panel variable:  clustscen3code (unbalanced)

.         xtmixed response treatcode || clustscen3code:, variance robust cov(exch) 
Note: single-variable random-effects specification in clustscen3code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood = -129.59127  
Iteration 1:   log pseudolikelihood = -129.59127  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen3code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          3
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =       1.78
Log pseudolikelihood = -129.59127               Prob > chi2       =     0.1824

                         (Std. Err. adjusted for 4 clusters in clustscen3code)
------------------------------------------------------------------------------
             |               Robust
    response |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -792.4923   594.3198    -1.33   0.182    -1957.338     372.353
       _cons |   2019.044   1129.441     1.79   0.074     -194.621    4232.708
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen3~e: Identity       |
                  var(_cons) |   222541.3   102549.3      90192.09    549101.9
-----------------------------+------------------------------------------------
               var(Residual) |   154862.1   78617.31      57256.39    418857.4
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen3code |   .5896643   .1242081      .3444441    .7971713
------------------------------------------------------------------------------

.         
.         xtset clustscen4code
       panel variable:  clustscen4code (unbalanced)

.         xtmixed response treatcode || clustscen4code:, variance robust cov(exch)
Note: single-variable random-effects specification in clustscen4code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood = -131.51138  
Iteration 1:   log pseudolikelihood = -131.51138  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen4code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          3
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =       1.13
Log pseudolikelihood = -131.51138               Prob > chi2       =     0.2885

                         (Std. Err. adjusted for 4 clusters in clustscen4code)
------------------------------------------------------------------------------
             |               Robust
    response |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -550.8784   518.9929    -1.06   0.288    -1568.086     466.329
       _cons |   1532.032   969.7242     1.58   0.114    -368.5927    3432.656
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen4~e: Identity       |
                  var(_cons) |   141314.6   65590.65      56899.05    350969.2
-----------------------------+------------------------------------------------
               var(Residual) |   226860.5   150432.3      61847.61    832136.7
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen4code |   .3838245   .1912594      .1132101    .7524403
------------------------------------------------------------------------------

.         xtset clustscen5code
       panel variable:  clustscen5code (unbalanced)

.         xtmixed response treatcode || clustscen5code:, variance robust cov(exch)
Note: single-variable random-effects specification in clustscen5code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood =  -130.0045  
Iteration 1:   log pseudolikelihood =  -130.0045  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen5code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          3
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =       2.05
Log pseudolikelihood =  -130.0045               Prob > chi2       =     0.1525

                         (Std. Err. adjusted for 4 clusters in clustscen5code)
------------------------------------------------------------------------------
             |               Robust
    response |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -835.8584   584.2482    -1.43   0.153    -1980.964     309.247
       _cons |   2059.281   1123.861     1.83   0.067     -143.446    4262.009
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen5~e: Identity       |
                  var(_cons) |   209990.8   109772.6      75376.35    585013.1
-----------------------------+------------------------------------------------
               var(Residual) |   166946.2   71242.53      72332.81    385316.7
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen5code |   .5570979   .1288837      .3112272    .7778486
------------------------------------------------------------------------------

.         
. * regression using log2 transformed response:
.         
.         xtset clustscen1code
       panel variable:  clustscen1code (unbalanced)

.         xtmixed responselog treatcode || clustscen1code:, variance robust cov(exch) 
Note: single-variable random-effects specification in clustscen1code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood = -22.943392  
Iteration 1:   log pseudolikelihood = -22.943392  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen1code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          4
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =       1.38
Log pseudolikelihood = -22.943392               Prob > chi2       =     0.2408

                         (Std. Err. adjusted for 4 clusters in clustscen1code)
------------------------------------------------------------------------------
             |               Robust
responselog2 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -1.314653    1.12069    -1.17   0.241    -3.511165    .8818582
       _cons |    10.9384   1.844878     5.93   0.000     7.322509     14.5543
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen1~e: Identity       |
                  var(_cons) |   .8106625   .0742105      .6775143    .9699776
-----------------------------+------------------------------------------------
               var(Residual) |    .545505   .2061001      .2601368     1.14392
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen1code |   .5977599   .1010516      .3947045    .7720387
------------------------------------------------------------------------------
.         
.         xtset clustscen2code
       panel variable:  clustscen2code (unbalanced)

.         xtmixed responselog treatcode || clustscen2code:, variance robust cov(exch) 
Note: single-variable random-effects specification in clustscen2code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood = -26.745317  
Iteration 1:   log pseudolikelihood = -26.649397  
Iteration 2:   log pseudolikelihood = -26.648269  
Iteration 3:   log pseudolikelihood = -26.648269  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen2code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          4
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =      41.86
Log pseudolikelihood = -26.648269               Prob > chi2       =     0.0000

                         (Std. Err. adjusted for 4 clusters in clustscen2code)
------------------------------------------------------------------------------
             |               Robust
responselog2 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -1.401528    .216617    -6.47   0.000    -1.826089   -.9769663
       _cons |   11.02528   .4313362    25.56   0.000     10.17987    11.87068
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen2~e: Identity       |
                  var(_cons) |   1.54e-24   3.23e-22      1.1e-203    2.2e+155
-----------------------------+------------------------------------------------
               var(Residual) |   1.346103   .2968238      .8737415    2.073831
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen2code |   1.14e-24          0      1.14e-24    1.14e-24
------------------------------------------------------------------------------

.         xtset clustscen3code
       panel variable:  clustscen3code (unbalanced)

.         xtmixed responselog treatcode || clustscen3code:, variance robust cov(exch) 
Note: single-variable random-effects specification in clustscen3code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood = -23.962282  
Iteration 1:   log pseudolikelihood = -23.962282  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen3code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          3
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =       1.95
Log pseudolikelihood = -23.962282               Prob > chi2       =     0.1621

                         (Std. Err. adjusted for 4 clusters in clustscen3code)
------------------------------------------------------------------------------
             |               Robust
responselog2 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -1.515346   1.083962    -1.40   0.162    -3.639872    .6091802
       _cons |   11.33596   1.755035     6.46   0.000     7.896151    14.77576
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen3~e: Identity       |
                  var(_cons) |   .7198723   .0694397      .5958647    .8696877
-----------------------------+------------------------------------------------
               var(Residual) |   .6544243   .2680905      .2931956    1.460701
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen3code |   .5238115   .1230783      .2948816    .7431542
------------------------------------------------------------------------------

.         
.         xtset clustscen4code
       panel variable:  clustscen4code (unbalanced)

.         xtmixed responselog treatcode || clustscen4code:, variance robust cov(exch)
Note: single-variable random-effects specification in clustscen4code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood = -23.121021  
Iteration 1:   log pseudolikelihood = -23.121021  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen4code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          3
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =       0.93
Log pseudolikelihood = -23.121021               Prob > chi2       =     0.3361

                         (Std. Err. adjusted for 4 clusters in clustscen4code)
------------------------------------------------------------------------------
             |               Robust
responselog2 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -1.090596    1.13381    -0.96   0.336    -3.312822    1.131631
       _cons |   10.49018   1.876673     5.59   0.000     6.811973     14.1684
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen4~e: Identity       |
                  var(_cons) |   .8241105   .0781859       .684273    .9925251
-----------------------------+------------------------------------------------
               var(Residual) |   .5595818   .1863314      .2913585     1.07473
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen4code |    .595588    .086908      .4206568     .749192
------------------------------------------------------------------------------


.         
.         xtset clustscen5code
       panel variable:  clustscen5code (unbalanced)

.         xtmixed responselog treatcode || clustscen5code:, variance robust cov(exch)
Note: single-variable random-effects specification in clustscen5code equation; covariance structure set
      to identity

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log pseudolikelihood = -24.483861  
Iteration 1:   log pseudolikelihood = -24.483861  

Computing standard errors:

Mixed-effects regression                        Number of obs     =         17
Group variable: clustscen5code                  Number of groups  =          4

                                                Obs per group:
                                                              min =          3
                                                              avg =        4.2
                                                              max =          5

                                                Wald chi2(1)      =       2.50
Log pseudolikelihood = -24.483861               Prob > chi2       =     0.1136

                         (Std. Err. adjusted for 4 clusters in clustscen5code)
------------------------------------------------------------------------------
             |               Robust
responselog2 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   treatcode |  -1.665269   1.052521    -1.58   0.114    -3.728173    .3976344
       _cons |   11.47776   1.734826     6.62   0.000     8.077565    14.87796
------------------------------------------------------------------------------

------------------------------------------------------------------------------
                             |               Robust           
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
clustscen5~e: Identity       |
                  var(_cons) |   .6512399   .0913297      .4947305    .8572615
-----------------------------+------------------------------------------------
               var(Residual) |   .7225407   .2610256      .3559235     1.46679
------------------------------------------------------------------------------

.         estat icc

Residual intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
              clustscen5code |   .4740494    .117256      .2639286    .6937813
------------------------------------------------------------------------------
*/
	



***************************************************************************************************
***************************************************************************************************
*																
*     	POWER calculations: POST HOC AFTER STUDY COMPLETED 			
*	In the equations below: ICC is rho() both refer to the same correlation 					
*
***************************************************************************************************
***************************************************************************************************



***************************************************************************************************
***************************************************************************************************
*
* 	1) 	POWER calculation for two independent means non paired.
*
***************************************************************************************************
***************************************************************************************************

*		It needs mean and Sd of treatment groups. Also expected alpha (significance) of 0.05. 
* 		And sample size (n) per group.

sort treatment response
by treatment: summarize response responselog

/*

-> 1 treatment = chow

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          8    1083.125    836.0577        150       2350
responselog2 |          8     9.62375    1.332409       7.23       11.2

-------------------------------------------------------------------------------------------------------
-> 2 treatment = wsd

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    response |          9    408.8889    386.3109        130       1250
responselog2 |          9    8.222222    1.143271       7.02      10.29

*/

*---------------------------------  STUDY POWER for cageScenario0 as published power calculation assuming one mouse per cage

power twomeans 1083 408, sd1(836) sd2(386) n1(8) n2(9)

/*

Estimated power for a two-sample means test
Satterthwaite's t test assuming unequal variances
Ho: m2 = m1  versus  Ha: m2 != m1

Study parameters:

        alpha =    0.0500
            N =        17
           N1 =         8
           N2 =         9
        N2/N1 =    1.1250
        delta = -675.0000
           m1 = 1083.0000
           m2 =  408.0000
          sd1 =  836.0000
          sd2 =  386.0000

Estimated power:

        power =    0.4697
*/


***************************************************************************************************
***************************************************************************************************
*
* 	2) 	POWER calculation for two independent means non paired but containing clustered/cages data.
*
***************************************************************************************************
***************************************************************************************************

*		It needs mean and SD of treatment groups. Also expected alpha (significance) of 0.05. 
* 		And sample size (n) per group.
*		Also number of clusters -cages- (k)
*		Number of mice per cluster for each group.
*		And a measure of correlation for mice within each cluster; specifically Intra Class Correlation parameter computed using mixed models above for instance.


ICCs computed above:
------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
RESPONSE      clustscen1code |   .5400716   .1697282      .2353012    .8175563
              clustscen2code |   2.91e-22          0      2.91e-22    2.91e-22
              clustscen3code |   .5896643   .1242081      .3444441    .7971713
              clustscen4code |   .3838245   .1912594      .1132101    .7524403
              clustscen5code |   .5570979   .1288837      .3112272    .7778486
------------------------------------------------------------------------------
RESPONSELOG2  clustscen1code |   .5977599   .1010516      .3947045    .7720387
              clustscen2code |   1.14e-24          0      1.14e-24    1.14e-24
              clustscen3code |   .5238115   .1230783      .2948816    .7431542
              clustscen4code |    .595588    .086908      .4206568     .749192
              clustscen5code |   .4740494    .117256      .2639286    .6937813

------------------------------------------------------------------------------
*/

*power based on response for clustered (cages) data as published assuming rho is 0.00001.


power twomeans 1083 408, sd1(836) sd2(386) k1(8) k2(9) m1(1) m2(1) nfractional rho(0.00001) table /*graph*/

/*
  +------------------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho CV_cluster |
  |------------------------------------------------------------------------------------------------------------|
  |     .05   .5533       8       9       1       1    -675    1083     408     836     386 1.0e-05    1.0e-09 |
  +------------------------------------------------------------------------------------------------------------+
*/

*##############################
*INTERPRETATION:
*Studies should ideally have power >0.8
*The study, even if conducted with single-caged mice, would have low power (0.55) and would require the inclusion of more mice.
*##############################


*---------------------------------     cageScenario1 - power calculation using ICC for power calculation for response and responselog2

*RESPONSE raw data
power twomeans 1083 408, sd1(836) sd2(386) k1(2) k2(2) m1(5) m2(5) nfractional rho(0.2353012,0.5400716, 0.8175563) table /*graph*/
*RESPONSELOG2 transformed data
power twomeans 9.62375 8.222222, sd1(1.332409) sd2(1.143271) k1(2) k2(2) m1(5) m2(5) nfractional rho(.3947045, .5977599,.7720387) table /*graph*/

/* OUTPUT:

Estimated power for a two-sample means test
Cluster randomized design, z test
Ho: m2 = m1  versus  Ha: m2 != m1

  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .3837       2       2       5       5    -675    1083     408     836     386   .2353 |
  |     .05   .2565       2       2       5       5    -675    1083     408     836     386   .5401 |
  |     .05    .202       2       2       5       5    -675    1083     408     836     386   .8176 |
  +-------------------------------------------------------------------------------------------------+
  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .3492       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .3947 |
  |     .05   .2783       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .5978 |
  |     .05   .2391       2       2       5       5  -1.402   9.624   8.222   1.332   1.143    .772 |
  +-------------------------------------------------------------------------------------------------+


*/

*---------------------------------     cageScenario2  ------------------------------------------------------

power twomeans 1083 408, sd1(836) sd2(386) k1(2) k2(2) m1(5) m2(5) nfractional rho(2.91e-22, 2.91e-22, 2.91e-22) table /*graph*/
power twomeans 9.62375 8.222222, sd1(1.332409) sd2(1.143271) k1(2) k2(2) m1(5) m2(5) nfractional rho(1.14e-24, 1.14e-24, 1.14e-24) table /*graph*/

/* OUTPUT:
  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .6399       2       2       5       5    -675    1083     408     836     386 2.9e-22 |
  |     .05   .6399       2       2       5       5    -675    1083     408     836     386 2.9e-22 |
  |     .05   .6399       2       2       5       5    -675    1083     408     836     386 2.9e-22 |
  +-------------------------------------------------------------------------------------------------+
  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .7138       2       2       5       5  -1.402   9.624   8.222   1.332   1.143 1.1e-24 |
  |     .05   .7138       2       2       5       5  -1.402   9.624   8.222   1.332   1.143 1.1e-24 |
  |     .05   .7138       2       2       5       5  -1.402   9.624   8.222   1.332   1.143 1.1e-24 |
  +-------------------------------------------------------------------------------------------------+
*/



*---------------------------------     cageScenario3  ------------------------------------------------------

power twomeans 1083 408, sd1(836) sd2(386) k1(2) k2(2) m1(5) m2(5) nfractional rho(.3444441,.5896643,.7971713) table /*graph*/
power twomeans 9.62375 8.222222, sd1(1.332409) sd2(1.143271) k1(2) k2(2) m1(5) m2(5) nfractional rho(.2948816, .5238115, .7431542) table /*graph*/

/* OUTPUT:
RESPONSE
  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .3242       2       2       5       5    -675    1083     408     836     386   .3444 |
  |     .05   .2441       2       2       5       5    -675    1083     408     836     386   .5897 |
  |     .05    .205       2       2       5       5    -675    1083     408     836     386   .7972 |
  +-------------------------------------------------------------------------------------------------+
  RESPONSELOG
  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .4014       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .2949 |
  |     .05   .3001       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .5238 |
  |     .05   .2446       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .7432 |
  +-------------------------------------------------------------------------------------------------+
*/


*---------------------------------     cageScenario4  ------------------------------------------------------

power twomeans 1083 408, sd1(836) sd2(386) k1(2) k2(2) m1(5) m2(5) nfractional rho(.1132101 .3838245    .7524403) table /*graph*/
power twomeans 9.62375 8.222222, sd1(1.332409) sd2(1.143271) k1(2) k2(2) m1(5) m2(5) nfractional rho(.4206568 .595588    .749192) table /*graph*/

/* OUTPUT:
 RESPONSE
 +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .4854       2       2       5       5    -675    1083     408     836     386   .1132 |
  |     .05   .3074       2       2       5       5    -675    1083     408     836     386   .3838 |
  |     .05   .2121       2       2       5       5    -675    1083     408     836     386   .7524 |
  +-------------------------------------------------------------------------------------------------+
  RESPONSELOG
  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05    .338       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .4207 |
  |     .05   .2789       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .5956 |
  |     .05   .2435       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .7492 |
  +-------------------------------------------------------------------------------------------------+
*/


*---------------------------------     cageScenario5  ------------------------------------------------------

power twomeans 1083 408, sd1(836) sd2(386) k1(2) k2(2) m1(5) m2(5) nfractional rho(.3112272 .5570979    .7778486) table /*graph*/
power twomeans 9.62375 8.222222, sd1(1.332409) sd2(1.143271) k1(2) k2(2) m1(5) m2(5) nfractional rho(.2639286 .4740494   .6937813) table /*graph*/

/* OUTPUT:
  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .3401       2       2       5       5    -675    1083     408     836     386   .3112 |
  |     .05   .2521       2       2       5       5    -675    1083     408     836     386   .5571 |
  |     .05    .208       2       2       5       5    -675    1083     408     836     386   .7778 |
  +-------------------------------------------------------------------------------------------------+
  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .4211       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .2639 |
  |     .05   .3171       2       2       5       5  -1.402   9.624   8.222   1.332   1.143    .474 |
  |     .05    .255       2       2       5       5  -1.402   9.624   8.222   1.332   1.143   .6938 |
  +-------------------------------------------------------------------------------------------------+
*/


*##############################
*INTERPRETATION:
*Only scenario  2 has the best study power based on cluster analysis; 0.63 analyzing raw untransformed data, and 0.71 based on analysis of data in log2 scale.
*This is somehow counter intuitive because single cages is the best mean for independent data, therefore the larger power in this scenario reflect the arbitrary allocation of mice to hypothetical cages.
*Slight differences between original power estimation 0.55 and 0.63 falls within the 95%CI of the estimates for the mean groups which are very wide. 
*For instance see in diet chow: response mean,   1083.125; SD, 836.0577; min, 150; max 2350.
*##############################





*********************************************************************************
*********************************************************************************
*
*   	POWER TABLES 
* 	
* 	TO HELP DETERMINE DESIGN FOR NEW EXPERIMENTS 	
*	Number of cages and mice per cage in balanced and unbalanced designs		
*	In the equations below: ICC is rho()
*
*********************************************************************************
*********************************************************************************

* This syntax structure k1(1(1)5) tells STATA to compute, for various clusters K, to start at 1 cluster (in steps of 2 clusters) for up to 5 clusters. 

* - - - RESPONSE
*table computed for raw RESPONSE data for the experiment using the ICC computed for scenario 2, and the low mean and upper limits for the ICC of scenario 1.  
power twomeans 1083 408, sd1(836) sd2(386) k1(1(2)5) k2(1(2)5) m1(1(2)5) m2(1(2)5) rho(2.9e-22, 0.2353012,0.5400716, 0.8175563) table
/* OUTPUT
Estimated power for a two-sample means test
Cluster randomized design, z test
Ho: m2 = m1  versus  Ha: m2 != m1

  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .1135       1       1       1       1    -675    1083     408     836     386 2.9e-22 |
  |     .05   .1135       1       1       1       1    -675    1083     408     836     386   .2353 |
  |     .05   .1135       1       1       1       1    -675    1083     408     836     386   .5401 |
  |     .05   .1135       1       1       1       1    -675    1083     408     836     386   .8176 |
  |     .05   .1221       1       1       1       3    -675    1083     408     836     386 2.9e-22 |
  |     .05   .1199       1       1       1       3    -675    1083     408     836     386   .2353 |
  |     .05   .1172       1       1       1       3    -675    1083     408     836     386   .5401 |
see excel file attached to manuscript for complete table. 
*/


* - - - RESPONSELOG
*table computed for transformed RESPPONSELOG2 data for the experiment using the ICC computed for scenario 2, and the low mean and upper limits for the ICC of scenario 1.  
power twomeans 9.62375 8.222222, sd1(1.332409) sd2(1.143271) k1(1(2)5) k2(1(2)5) m1(1(2)5) m2(1(2)5) rho(1.14e-24 .5977599  .3947045 .7720387) table
/* OUTPUT
Estimated power for a two-sample means test
Cluster randomized design, z test
Ho: m2 = m1  versus  Ha: m2 != m1

  +-------------------------------------------------------------------------------------------------+
  |   alpha   power      K1      K2      M1      M2   delta      m1      m2     sd1     sd2     rho |
  |-------------------------------------------------------------------------------------------------|
  |     .05   .1135       1       1       1       1    -675    1083     408     836     386 2.9e-22 |
  |     .05   .1135       1       1       1       1    -675    1083     408     836     386   .2353 |
  |     .05   .1135       1       1       1       1    -675    1083     408     836     386   .5401 |
  |     .05   .1135       1       1       1       1    -675    1083     408     836     386   .8176 |
  |     .05   .1221       1       1       1       3    -675    1083     408     836     386 2.9e-22 |
  |     .05   .1199       1       1       1       3    -675    1083     408     836     386   .2353 |
  |     .05   .1172       1       1       1       3    -675    1083     408     836     386   .5401 |
see excel file attached to manuscript for complete table. 
*/



power twomeans 10 15, k1(1(1)5) k2(1(1)5) m1(1(2)5) m2(1(2)5) sd(4) rho(0.01) table

